# **任务管理模块规范 (Tasks/To-Do List)**

## **1\. 模块目标 (Module Goal)**

本模块旨在为用户（尤其是 Employee/User 角色）提供一个**执行中心**，集中管理和追踪所有分配给他们的任务，并处理任务的核心操作：标记完成和文件上传。

## **2\. 前端 UI/UX 规范 (Frontend UI/UX Specification)**

### **2.1. Tasks 页面结构 (tasks.html)**

前端页面应遵循响应式设计，以列表形式展示所有任务，并具有以下核心元素：

| UI 元素 | 规范 | 交互/样式 |
| :---- | :---- | :---- |
| **任务列表** | 只显示 **当前登录用户** 被分配的所有任务。 | 默认按截止日期或创建日期排序。 |
| **筛选/排序** | 允许用户按“项目名称”、“状态（Open/Done）”进行筛选。 | 使用 JavaScript (JS) 动态过滤列表，无需页面刷新。 |
| **单个任务卡片** | 每个任务应包含：项目名称、任务标题、指派者 (Gravatar 头像)、截止日期、任务状态。 | 样式应清晰区分“Open”和“Done”状态（例如，完成的任务文字置灰并划掉）。 |
| **完成复选框** | 每个任务旁边必须有一个 **Checkbox**。 | **点击后立即通过 Fetch API 通知后端更新状态**，前端同步更新任务卡片样式。 |
| **文件上传入口** | 任务卡片上应有一个按钮/图标（例如：📎）用于上传文件。 | 点击后弹出一个模态框 (Modal) 来处理文件选择和上传。 |
| **文件下载区** | 如果任务已有关联文件，显示文件名和下载图标 (⬇)。 | 点击后触发下载流程（见后端规范）。 |

### **2.2. 文件上传模态框 (Modal)**

当用户点击上传按钮时，应弹出一个包含以下元素的模态框：

1. **文件选择字段：** 允许用户选择一个文件。  
2. **文件描述 (可选)：** 用户可以添加对该文件的简短说明。  
3. **上传按钮：** 触发 Fetch API 请求，将文件发送到后端。  
4. **进度指示器：** (可选，但推荐) 在上传过程中显示一个进度条或“Loading”动画。

## **3\. 后端 PHP 脚本与逻辑 (Backend PHP & Logic)**

后端职责在于处理数据获取、状态更新、文件上传和最重要的**权限与安全检查**。

### **3.1. 数据获取脚本 (PHP/get\_tasks.php)**

* **职责：** 从数据库中提取当前用户的所有任务数据，并以 **JSON 格式**返回给前端。  
* **Session 检查：** 必须使用 $\_SESSION\['user\_id'\] 作为查询条件。  
  SELECT \* FROM tasks WHERE assigned\_user\_id \= $\_SESSION\['user\_id'\] ORDER BY created\_at DESC

* **输出：** 返回任务列表的 JSON 数组。

### **3.2. 任务状态更新 (PHP/update\_task\_status.php)**

* **触发点：** 前端 Checkbox 状态变更时，通过 Fetch API 发送请求。  
* **输入：** 接收 task\_id 和新的 status (e.g., 'Done' 或 'Open')。  
* **权限检查 (核心)：**  
  1. **认证：** 检查用户是否登录 ($\_SESSION\['user\_id'\])。  
  2. **授权：** 检查 task\_id 是否确实分配给了当前登录用户。  
     UPDATE tasks SET status \= ? WHERE id \= ? AND assigned\_user\_id \= $\_SESSION\['user\_id'\]

* **项目进度更新 (强制)：** 状态更新成功后，必须调用一个函数或方法（例如 Project::updateProgress($project\_id)）来**重新计算**并更新所属项目的 progress\_percent。

### **3.3. 文件上传处理 (PHP/upload\_file.php)**

* **触发点：** 前端模态框中的上传按钮提交表单数据（通常使用 FormData 对象）。  
* **输入：** 接收 task\_id 和文件数据 ($\_FILES)。  
* **安全与存储：**  
  1. **文件类型/大小验证：** 验证文件扩展名是否安全（例如，不允许 .exe 或 .php）。  
  2. **存储：** 将文件移动到 Web 根目录之外的安全存储位置，使用 **唯一的、难以猜测的文件名**（例如：UUID 或时间戳 \+ 原始文件名哈希）。  
  3. **数据库更新：** 在 tasks 表中更新 file\_path 和 file\_name 字段。

### **3.4. 文件下载处理 (PHP/download\_file.php)**

* **触发点：** 用户点击下载图标时，请求发送到此脚本，附带 task\_id。  
* **权限检查 (核心)：**  
  1. **项目成员验证：** 必须查询数据库，确认当前 $\_SESSION\['user\_id'\] 是否是该任务所属项目的成员。  
  2. **文件路径验证：** 严格验证从数据库获取的文件路径，防止目录遍历攻击（Directory Traversal Attacks）。  
* **下载执行：**  
  1. 读取服务器上的文件内容。  
  2. 设置正确的 HTTP Headers (Content-Type 和 Content-Disposition)，将文件内容输出到浏览器，实现强制下载。